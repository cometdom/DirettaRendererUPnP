[Unit]
Description=Diretta UPnP Renderer
Documentation=https://github.com/cometdom/DirettaRendererUPnP
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/diretta-renderer-upnp
EnvironmentFile=-/opt/diretta-renderer-upnp/diretta-renderer.conf
ExecStart=/opt/diretta-renderer-upnp/start-renderer.sh

# Restart policy
Restart=on-failure
RestartSec=5

# Logging
StandardOutput=journal
StandardError=journal
SyslogIdentifier=diretta-renderer

# --- Capabilities ---
# Start as root for network init, drop to DROP_USER via --user option
# CAP_SETUID/CAP_SETGID: needed for setuid()/setgid() during privilege drop
# CAP_NET_RAW/CAP_NET_ADMIN: needed for Diretta raw sockets
# CAP_SYS_NICE: needed for real-time thread priority
AmbientCapabilities=CAP_NET_RAW CAP_NET_ADMIN CAP_SYS_NICE CAP_SETUID CAP_SETGID
CapabilityBoundingSet=CAP_NET_RAW CAP_NET_ADMIN CAP_SYS_NICE CAP_SETUID CAP_SETGID

# --- Filesystem isolation ---
ProtectSystem=strict
ProtectHome=true
PrivateTmp=true
ReadOnlyPaths=/opt/diretta-renderer-upnp
ReadWritePaths=/var/log

# --- Device and kernel isolation ---
PrivateDevices=true
ProtectKernelTunables=true
ProtectKernelModules=true
ProtectKernelLogs=true
ProtectControlGroups=true
ProtectClock=true
ProtectHostname=true

# --- Misc hardening ---
LockPersonality=true
MemoryDenyWriteExecute=true
RestrictRealtime=false
RestrictSUIDSGID=true
RemoveIPC=true
RestrictNamespaces=true
RestrictAddressFamilies=AF_INET AF_INET6 AF_NETLINK AF_UNIX AF_PACKET

# --- System call filtering ---
SystemCallArchitectures=native
SystemCallFilter=~@mount @keyring @debug @module @swap @reboot @obsolete

# --- Performance ---
Nice=-10
IOSchedulingClass=realtime
IOSchedulingPriority=0

[Install]
WantedBy=multi-user.target
